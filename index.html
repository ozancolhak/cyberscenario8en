<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Scenario v8: TRAFFIC TSUNAMI: Large-Scale DDoS Crisis</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/dracula.min.css">
    <style>
        :root {
            --dark-bg: #1a1a2e;
            --container-bg: #2a2a4a;
            --section-bg: #333355;
            --interactive-bg: #444466;
            --accent-blue: #8be9fd;
            --accent-purple: #bd93f9;
            --accent-pink: #ff79c6;
            --accent-green: #50fa7b;
            --accent-yellow: #f1fa8c;
            --accent-red: #ff5555;
            --text-light: #e0e0e0;
            --text-dark: #282a36;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--dark-bg); 
            color: var(--text-light); 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            min-height: 100vh;
            font-size: 0.95em; 
        }

        .container { 
            background-color: var(--container-bg); 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            padding: 20px; 
            max-width: 950px; 
            width: 100%; 
            margin: 40px 0; 
        }

        @media (min-width: 768px) { .container { padding: 40px; } }

        .centered-page { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            min-height: 60vh; 
            animation: fadeIn 0.5s ease-out; 
        }

        h1 { font-size: 2.4em; color: var(--accent-blue); margin-bottom: 20px; }
        h2 { font-size: 1.9em; color: var(--accent-blue); border-bottom: 2px solid var(--interactive-bg); padding-bottom: 15px; margin-bottom: 25px; text-align: left; }
        h3 { font-size: 1.5em; color: var(--accent-purple); text-align: left; margin-top: 25px; margin-bottom: 15px; }
        h4 { font-size: 1.1em; color: var(--accent-yellow); text-align: left; margin-top: 0; border-bottom: 1px solid var(--interactive-bg); padding-bottom: 10px; }
        p { line-height: 1.7; font-size: 1em; }

        .section { display: none; padding: 20px; background-color: var(--section-bg); border-radius: 8px; margin-top: 25px; animation: fadeIn 0.5s ease-out; }
        @media (min-width: 768px) { .section { padding: 30px; } }

        .interactive-element { background-color: var(--interactive-bg); border-radius: 8px; padding: 20px; margin-top: 20px; }
        .decision-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 30px; }
        .btn { background-color: #6272a4; color: white; border: none; padding: 15px 25px; border-radius: 8px; cursor: pointer; font-size: 1.1em; transition: all 0.3s ease; text-align: left; display: flex; align-items: center; gap: 15px; font-weight: 700; }
        .btn:hover { background-color: #7a8ab9; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn:disabled { background-color: #555 !important; color: #999 !important; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.7; }
        .btn .btn-text { flex-grow: 1; }
        .btn small { display: block; font-size: 0.85em; opacity: 0.8; margin-top: 5px; font-weight: 400; }
        .btn-start, .btn-continue { font-size: 1.3em; font-weight: bold; text-align: center; background-color: var(--accent-green); color: var(--text-dark); justify-content: center; }

        #intermissionSection .metric-change { font-size: 1.2em; margin: 15px 0; display: flex; align-items: center; gap: 10px; }
        .metric-change .positive { color: var(--accent-green); }
        .metric-change .negative { color: var(--accent-red); }
        .metric-change .neutral { color: var(--accent-blue); } 

        #statusBar { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px; background-color: var(--text-dark); padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #6272a4; }
        #statusBar .metric { text-align: center; font-size: 0.9em; flex: 1; min-width: 100px; } 
        #statusBar .metric .value { font-size: 1.3em; font-weight: bold; color: var(--accent-yellow); }

        .final-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 20px; width: 100%; max-width: 850px; } 
        .metric-card { background-color: var(--section-bg); padding: 25px; border-radius: 8px; text-align: center; border: 1px solid var(--interactive-bg); transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 150px; }
        .metric-card:hover { transform: scale(1.05); border-color: var(--accent-blue); }
        .metric-card .icon { font-size: 2.5em; color: var(--accent-blue); margin-bottom: 10px; }
        .metric-card .label { font-size: 1.1em; margin-bottom: 5px; color: var(--text-light); }
        .metric-card .value { font-size: 1.8em; font-weight: bold; color: var(--accent-yellow); }

        .code-block, .slack-chat { background-color: var(--text-dark); border: 1px solid #6272a4; border-radius: 8px; padding: 20px; margin-top: 15px; white-space: pre-wrap; word-break: break-all; font-family: 'Consolas', monospace; }
        .learning-note { background-color: var(--text-dark); border-left: 5px solid var(--accent-blue); padding: 20px; border-radius: 8px; margin-top: 30px; }
        .scenario-image { width: 100%; max-width: 500px; margin: 25px auto; display: block; border-radius: 8px; border: 1px solid var(--interactive-bg); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .slack-chat .message { margin-bottom: 10px; padding: 8px; border-radius: 5px; background-color: #3f3f5a; }
        .slack-chat .sender { font-weight: bold; color: var(--accent-pink); }
        .slack-chat .sender.ciso { color: var(--accent-green); }
        .slack-chat .sender.ops { color: var(--accent-yellow); }
        .slack-chat .sender.legal { color: var(--accent-blue); }
        .slack-chat .sender.ceo { color: var(--accent-purple); }
        .slack-chat .sender.cto { color: var(--accent-green); } 
        .slack-chat .sender.pr { color: var(--accent-pink); } 
        .slack-chat .sender.finance { color: var(--accent-red); } 
        .slack-chat .sender.vendor { color: var(--accent-blue); }

        .suspect-card { background-color: var(--interactive-bg); border-radius: 8px; padding: 20px; margin-bottom: 15px; border-left: 5px solid var(--accent-purple); box-shadow: 0 2px 8px rgba(0,0,0,0.2); text-align: left;}
        .suspect-card h4 { margin-top: 0; margin-bottom: 10px; border-bottom: none; color: var(--accent-purple); }
        .suspect-card p {font-size: 0.9em; line-height: 1.6;}
        .suspect-card strong { color: var(--accent-yellow); }

        #finalSection { text-align: center; }
        #performance-badge-container { margin: 25px 0; }
        #performance-badge { padding: 12px 30px; font-size: 1.8em; font-weight: bold; border-radius: 50px; display: inline-block; color: var(--text-dark); box-shadow: 0 5px 20px rgba(0,0,0,0.4); transition: transform 0.3s ease; }
        #performance-badge:hover { transform: scale(1.05); }
        .post-crisis-layout { display: grid; grid-template-columns: 1fr; gap: 30px; text-align: left; margin-top: 40px; width: 100%; }
        @media (min-width: 800px) { .post-crisis-layout { grid-template-columns: 1fr 1fr; } }
        .event-timeline, .strategic-debrief { background-color: var(--interactive-bg); padding: 25px; border-radius: 8px; border: 1px solid var(--section-bg); margin-top: 20px; }
        .event-timeline h3, .strategic-debrief h3 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid var(--section-bg); color: var(--accent-blue); display: flex; align-items: center; gap: 10px; }
        .event-timeline ul { list-style-type: none; padding-left: 0; margin: 15px 0 0 0; }
        .event-timeline li { position: relative; padding: 5px 0 15px 35px; border-left: 2px solid var(--section-bg); font-size: 0.95em; }
        .event-timeline li:last-child { border-left: none; }
        .event-timeline li::before { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: var(--accent-green); position: absolute; left: -12px; top: 5px; background-color: var(--dark-bg); width: 22px; height: 22px; border-radius: 50%; text-align: center; line-height: 22px; font-size: 0.8em; border: 2px solid var(--section-bg); }
        .event-timeline li.negative::before { content: '\f00d'; color: var(--accent-red); }
        .event-timeline li.neutral::before { content: '\f05a'; color: var(--accent-blue); }
        .event-timeline li .decision-title { font-weight: bold; color: var(--accent-purple); display: block; margin-bottom: 4px; }
        .event-timeline li .decision-impact { font-style: italic; opacity: 0.8; font-size: 0.9em; }
        #strategic-debrief-content p { font-size: 1em; margin-bottom: 15px; }

        .intro-info-grid { display: grid; grid-template-columns: 1fr; gap: 30px; margin-top: 30px; width: 100%; max-width: 800px; text-align: left; }
        @media (min-width: 768px) { .intro-info-grid { grid-template-columns: 1fr 1fr; } }

        .intro-roles-container, .intro-metrics-container {
            background-color: var(--section-bg);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            border: 1px solid var(--interactive-bg);
        }
        .intro-roles-container h3, .intro-metrics-container h3 {
            margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid var(--interactive-bg);
            color: var(--accent-purple); text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .intro-roles-container ul, .intro-metrics-container ul { list-style: none; padding: 0; margin: 0; }
        .intro-roles-container li, .intro-metrics-container li {
            display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 10px 0; border-bottom: 1px dashed var(--interactive-bg); font-size: 1.05em;
        }
        .intro-roles-container li:last-child, .intro-metrics-container li:last-child { border-bottom: none; margin-bottom: 0; }
        .intro-roles-container li .icon, .intro-metrics-container li .icon { font-size: 1.8em; color: var(--accent-blue); flex-shrink: 0; width: 35px; text-align: center; }
        .intro-roles-container li strong { color: var(--accent-yellow); }
        .intro-roles-container li small { display: block; font-size: 0.9em; color: var(--text-light); opacity: 0.8; margin-top: 3px; }

        /* === Leaderboard (modal) â€” new design === */
.lb-overlay{
    display:none; position:fixed; inset:0;
    background: rgba(10,10,25,.7);
    -webkit-backdrop-filter: blur(4px);
    backdrop-filter: blur(4px);
    z-index:9999; align-items:center; justify-content:center; padding:20px;
}
.lb-modal{
    background: linear-gradient(180deg, #2a2a4a 0%, #1f1f36 100%);
    color: var(--text-light);
    width:100%; max-width: 760px; border-radius:14px; padding:22px 22px 16px;
    border:1px solid rgba(255,255,255,.08);
    box-shadow: 0 18px 50px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.04);
}
.lb-header{
    display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px;
}
.lb-title{
    display:flex; align-items:center; gap:10px;
    font-size:1.25em; font-weight:800; letter-spacing:.2px; color: var(--accent-yellow);
}
.lb-title i{ filter: drop-shadow(0 2px 6px rgba(0,0,0,.35)); }
.lb-sub{ font-size:.92em; opacity:.85; color:#cfd3ff; }

.lb-tablewrap{
    margin-top:10px;
    max-height: 60vh; overflow:auto;
    border:1px solid var(--interactive-bg); border-radius:10px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
}

/* Table */
table.lb-table{ width:100%; border-collapse:collapse; font-size:.97em; }
table.lb-table th, table.lb-table td{ padding:10px 12px; text-align:left; }
table.lb-table thead th{
    position: sticky; top:0; z-index:1;
    background:#1f1f36; color:#e9e9ff;
    border-bottom: 1px solid #3b3b66;
    font-weight:700; letter-spacing:.3px;
}
table.lb-table tbody td{ border-bottom:1px solid rgba(255,255,255,.06); color:#e9e9f5; }
table.lb-table tbody tr:hover{ background-color: rgba(255,255,255,.045); }

/* Highlight top 3 + badge */
table.lb-table tbody tr:nth-child(1){
    background: linear-gradient(90deg, rgba(255,215,0,.18), transparent 65%);
}
table.lb-table tbody tr:nth-child(1) td:first-child::after{ content:" ðŸ¥‡"; }
table.lb-table tbody tr:nth-child(2){
    background: linear-gradient(90deg, rgba(192,192,192,.18), transparent 65%);
}
table.lb-table tbody tr:nth-child(2) td:first-child::after{ content:" ðŸ¥ˆ"; }
table.lb-table tbody tr:nth-child(3){
    background: linear-gradient(90deg, rgba(205,127,50,.18), transparent 65%);
}
table.lb-table tbody tr:nth-child(3) td:first-child::after{ content:" ðŸ¥‰"; }

/* Bottom action buttons */
.lb-actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:14px; }
.lb-close, .lb-refresh{
    border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700;
    transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
}
.lb-refresh{ background: var(--accent-blue); color:#0c1130; }
.lb-close{ background: #3d3d60; color:#fff; }
.lb-refresh:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(139,233,253,.22); }
.lb-close:hover{ transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,.35); }

/* Small screen improvements */
@media (max-width: 420px){
  .lb-title{ font-size:1.05em; }
  table.lb-table th, table.lb-table td{ padding:9px 10px; }
}

    </style>
</head>
<body>
    <div class="container">
        
        <div id="introSection" class="centered-page">
            <h1><i class="fa-solid fa-water"></i> TRAFFIC TSUNAMI: Large-Scale DDoS Crisis</h1>
            <p style="max-width: 600px;">Welcome, **Ã‡OLHAK Teknoloji's** **Network Security Expert**! Your mission is critical: You are under a **large-scale DDoS attack** by an international botnet targeting your company's main servers. Websites, services, and even internal network connections are on the verge of disruption. This attack is threatening business continuity and causing significant reputational damage by overloading your systems. Your mission: Race against time to mitigate the attack, reroute traffic, protect the infrastructure, and ensure business continuity!</p>
            <img src="intro.png" alt="DDoS attack themed intro image" class="scenario-image">

            <div class="intro-info-grid">
                <div class="intro-roles-container">
                    <h3><i class="fa-solid fa-people-arrows"></i> Simulation Roles</h3>
                    <ul>
                        <li class="your-role">
                            <span class="icon"><i class="fa-solid fa-network-wired"></i></span>
                            <div>
                                <strong>Your Role: Network Security Expert</strong> 
                                <small>You are responsible for the security of the company's network infrastructure. You play an active role in DDoS mitigation steps. Your choices will directly affect the outcome.</small>
                            </div>
                        </li>
                        <li><span class="icon"><i class="fa-solid fa-user-tie"></i></span><div><strong>CISO Melih Kaan</strong> <small>Responsible for security, expects fast and effective mitigation.</small></div></li>
                        <li><span class="icon"><i class="fa-solid fa-microchip"></i></span><div><strong>CTO Onur GÃ¼ngor</strong> <small>Infrastructure performance and business continuity are the top priorities.</small></div></li>
                        <li><span class="icon"><i class="fa-solid fa-users-gear"></i></span><div><strong>CEO Ayfer YÄ±ldÄ±z</strong> <small>Wants to minimize company reputation and financial losses.</small></div></li>
                        <li><span class="icon"><i class="fa-solid fa-cloud"></i></span><div><strong>CDN/DDoS Protection Provider</strong> <small>Will provide external support, but may not always respond quickly.</small></div></li>
                    </ul>
                </div>

                <div class="intro-metrics-container">
                    <h3><i class="fa-solid fa-chart-line"></i> Key Metrics</h3>
                    <ul>
                        <li><span class="icon" style="color: var(--accent-red);"><i class="fa-solid fa-gauge-high"></i></span><div><strong>System Load</strong> <small>The resistance of the servers to DDoS traffic. (Starting: Extremely High)</small></div></li>
                        <li><span class="icon" style="color: var(--accent-green);"><i class="fa-solid fa-shield-virus"></i></span><div><strong>Attack Effectiveness</strong> <small>The strength and impact of the DDoS attack. (Starting: Full)</small></div></li>
                        <li><span class="icon" style="color: var(--accent-yellow);"><i class="fa-solid fa-sack-dollar"></i></span><div><strong>Financial Loss</strong> <small>Cost resulting from the outage. (Starting: â‚º0)</small></div></li>
                        <li><span class="icon" style="color: var(--accent-blue);"><i class="fa-solid fa-hourglass-half"></i></span><div><strong>Downtime</strong> <small>Total duration of the service outage. (Starting: 0 Minutes)</small></div></li>
                        <li><span class="icon" style="color: var(--accent-pink);"><i class="fa-solid fa-heart-crack"></i></span><div><strong>Customer Satisfaction</strong> <small>Customer satisfaction with access to the service. (Starting: 100)</small></div></li>
                    </ul>
                </div>
            </div>
            <button class="btn btn-start" id="startButton"><i class="fa-solid fa-play"></i> Start Simulation</button>
        </div>

        <div id="intermissionSection" class="centered-page" style="display: none;">
            <h2 id="intermissionTitle"></h2>
            <p id="intermissionText" style="max-width: 600px;"></p>
            <div class="interactive-element" style="width: 100%; max-width: 500px;">
                <h4>Decision Impacts</h4>
                <div id="intermissionMetrics"></div>
            </div>
            <div class="interactive-element" style="width: 100%; max-width: 500px; border-left-color: var(--accent-blue); margin-top: 20px;">
                <h4>Strategic Assessment</h4>
                <p id="strategicText" style="font-size: 1em;"></p>
            </div>
            <button class="btn btn-continue" id="continueButton" style="margin-top: 30px;"><i class="fa-solid fa-forward"></i> Continue</button>
        </div>

        <div id="gameContainer" style="display: none;">
            <div id="statusBar">
                <div class="metric"><span><i class="fa-solid fa-gauge-high"></i> System Load</span><div class="value" id="status-systemLoad">Extremely High</div></div>
                <div class="metric"><span><i class="fa-solid fa-shield-virus"></i> Attack Effectiveness</span><div class="value" id="status-attackEffectiveness">Full</div></div>
                <div class="metric"><span><i class="fa-solid fa-sack-dollar"></i> Financial Loss</span><div class="value" id="status-financialLoss">â‚º0</div></div>
                <div class="metric"><span><i class="fa-solid fa-hourglass-half"></i> Downtime</span><div class="value" id="status-downtime">0 Minutes</div></div>
                <div class="metric"><span><i class="fa-solid fa-heart-crack"></i> Customer Satisfaction</span><div class="value" id="status-customerSatisfaction">100</div></div>
                <div class="metric" id="status-timer"><span><i class="fa-solid fa-stopwatch"></i> Time Remaining</span><div class="value" id="status-remaining">04:00</div></div>
            </div>
            <div id="game-content">

                <div id="ddos_phase1_initial_detection" class="section">
                    <h2><i class="fa-solid fa-wave-square"></i> Phase 1: Initial Detection and Traffic Anomaly</h2>
                    <h3>Time 0:00 - Traffic Alert!</h3>
                    <p>In the middle of the night, your network monitoring systems started sending critical alerts: "Abnormal traffic increase detected!" You quickly noticed a distributed and intense flood of requests, dozens of times larger than normal traffic, targeting your main servers. This is an obvious **large-scale DDoS attack**! Your website has started to slow down, and some users are even experiencing access issues.</p>
                    <img src="spike.png" alt="DDoS traffic spike visual" class="scenario-image">
                    <div class="interactive-element">
                        <div class="decision-buttons">
                            <button class="btn critical" data-decision="ddos-p1-enable-onprem-mitigation" data-next-section="ddos_phase2_cdn_contact"><i class="fa-solid fa-firewall"></i><div class="btn-text">Option A: Activate Existing On-Prem DDoS Mitigation Systems.<small>Start filtering traffic with your own infrastructure's solutions. This is fast but may have limited capacity.</small></div></button>
                            <button class="btn" data-decision="ddos-p1-contact-isp" data-next-section="ddos_phase2_cdn_contact"><i class="fa-solid fa-phone-volume"></i><div class="btn-text">Option B: Contact the ISP and Request Traffic Filtering.<small>Ask them to filter the attack traffic before it reaches your company's network. There's a risk of external dependency and delay.</small></div></button>
                        </div>
                    </div>
                    <div class="learning-note"><strong>Learning Note:</strong> The speed of initial response is vital in DDoS attacks. Using your own existing capacity can be a quick solution, but ISP support is necessary for larger attacks.</div>
                </div>

                <div id="ddos_phase2_cdn_contact" class="section">
                    <h2><i class="fa-solid fa-cloud-arrow-up"></i> Phase 2: Contacting CDN/DDoS Protection Provider</h2>
                    <h3>Time 0:45 - Response from CDN Provider!</h3>
                    <p>Although your on-prem solutions provided some relief, the scale of the attack continues. With the approval of the CISO and CTO, you initiated an urgent call with your CDN and DDoS protection provider (e.g., CloudFlare, Akamai). You explained the situation in detail. The provider stated they can activate their full-capacity traffic scrubbing service, but that full activation and traffic redirection could take **approximately 15-30 minutes**.</p>
                    <div class="interactive-element">
                    <img src="ddos.png" alt="DDoS attack themed intro image" class="scenario-image">

                        <h4>What will you do to ensure business continuity during this waiting period?</h4>
                        <div class="decision-buttons">
                            <button class="btn critical" data-decision="ddos-p2-temporary-service-degradation" data-next-section="ddos_phase3_traffic_diversion"><i class="fa-solid fa-minus-circle"></i><div class="btn-text">Option A: Temporarily Shut Down Some Non-Critical Services.<small>Reduce resource consumption to decrease system load and keep core services running.</small></div></button>
                            <button class="btn" data-decision="ddos-p2-scale-up-resources" data-next-section="ddos_phase3_traffic_diversion"><i class="fa-solid fa-arrow-up-right-dots"></i><div class="btn-text">Option B: Rapidly Scale Up/Out Server Resources.<small>Increase the capacity of existing servers or deploy additional ones. This can be costly.</small></div></button>
                        </div>
                    </div>
                    <div class="learning-note"><strong>Learning Note:</strong> The time it takes for external mitigation solutions to activate is crucial in DDoS attacks. Managing internal resources during this time is critical to minimize downtime.</div>
                </div>

                <div id="ddos_phase3_traffic_diversion" class="section">
                    <h2><i class="fa-solid fa-route"></i> Phase 3: Traffic Diversion and Damage Control</h2>
                    <h3>Time 1:30 - Traffic Scrubbing Has Started!</h3>
                    <p>Your CDN provider has stepped in and started scrubbing the attack traffic. Initial signals are positive; the system load is slowly decreasing. However, the attackers seem to have changed tactics; they are now focusing on Layer 7 (application layer) attacks, targeting specific API endpoints and session management. This is a smarter type of attack, focusing on resource exhaustion rather than bandwidth.</p>
                    <p>CTO Onur GÃ¼ngor calls: <em>"The attack strength has decreased, but we still have access issues! The APIs are slow. Complaints from our customers keep coming in. What do we do about this Layer 7 attack?"</em></p>
                    <img src="traffic.png" alt="Traffic diversion visual" class="scenario-image">
                    <div class="interactive-element">
                        <div class="decision-buttons">
                            <button class="btn critical" data-decision="ddos-p3-rate-limiting" data-next-section="ddos_phase4_communication_and_reputation"><i class="fa-solid fa-hand-holding-dollar"></i><div class="btn-text">Option A: Apply Rate Limiting at the Application Layer.<small>Restrict the request rate from specific IP addresses or user sessions. This might affect legitimate users.</small></div></button>
                            <button class="btn" data-decision="ddos-p3-captcha-challenges" data-next-section="ddos_phase4_communication_and_reputation"><i class="fa-solid fa-robot"></i><div class="btn-text">Option B: Introduce CAPTCHA Challenges for Suspicious Traffic.<small>Use interactive challenges like CAPTCHA to distinguish bot traffic. This can negatively impact user experience.</small></div></button>
                        </div>
                    </div>
                    <div class="learning-note"><strong>Learning Note:</strong> Layer 7 DDoS attacks are more sophisticated and cause service outages through resource exhaustion. Application layer measures like rate limiting and CAPTCHA are important against such attacks.</div>
                </div>

                <div id="ddos_phase4_communication_and_reputation" class="section">
                    <h2><i class="fa-solid fa-podcast"></i> Phase 4: Communication and Reputation Management</h2>
                    <h3>Time 2:30 - Media and Customer Pressure!</h3>
                    <p>The impact of the DDoS attack has gone public. Complaints on social media are piling up, and some news sites are featuring Ã‡OLHAK Teknoloji's service outages. The fact that a major e-commerce launch is planned for this week drives CEO Ayfer YÄ±ldÄ±z crazy: <em>"This situation is jeopardizing the launch! Our trust is shaken. What explanation will we give to customers? What about our financial losses?"</em></p>
                    <p>Your PR team and legal advisors have called for an urgent meeting on the content and timing of the public statement.</p>
                    <img src="media.png" alt="DDoS public pressure visual" class="scenario-image">
                    <div class="interactive-element">
                        <div class="decision-buttons">
                            <button class="btn" data-decision="ddos-p4-transparent-apology" data-next-section="ddos_phase5_post_attack_recovery"><i class="fa-solid fa-bullhorn"></i><div class="btn-text">Option A: Announce the Attack, Apologize, and Share Actions Taken.<small>Be transparent, announce that you are under a DDoS attack, and share your mitigation steps. Try to regain trust.</small></div></button>
                            <button class="btn critical" data-decision="ddos-p4-downplay-issue" data-next-section="ddos_phase5_post_attack_recovery"><i class="fa-solid fa-masks-theater"></i><div class="btn-text">Option B: Frame the Issue as 'Maintenance' or 'Technical Glitch'.<small>Avoid mentioning a DDoS attack and downplay the situation as an internal technical problem.</small></div></button>
                            <button class="btn" data-decision="ddos-p4-offer-compensation" data-next-section="ddos_phase5_post_attack_recovery"><i class="fa-solid fa-gift"></i><div class="btn-text">Option C: Offer Compensation to Users for the Service Disruption.<small>Provide incentives like discounts or free service to compensate for the financial loss.</small></div></button>
                        </div>
                    </div>
                    <div class="learning-note"><strong>Learning Note:</strong> The communication strategy during a cyber security incident directly impacts reputation and customer trust. Transparency is often the best approach.</div>
                </div>

                <div id="ddos_phase5_post_attack_recovery" class="section">
                    <h2><i class="fa-solid fa-circle-check"></i> Phase 5: Post-Attack Recovery and Lessons Learned</h2>
                    <h3>Time 3:30 - Attack Under Control!</h3>
                    <p>Thanks to the full support of your CDN provider and your proactive interventions, the DDoS attack is finally under control. Traffic has returned to normal levels and your services are fully accessible. However, it's time to evaluate the effects of the attack and strengthen your infrastructure against potential future attacks. You are having a post-crisis meeting with the CISO, CTO, and CEO.</p>
                    <div class="interactive-element">
                        <h4>With the lessons learned from this major DDoS attack, how will you strengthen your future defense?</h4>
                        <div class="slack-chat" id="slackChatDDoS_P5"></div>
                        <div class="decision-buttons">
                            <button class="btn critical" data-decision="ddos-p5-invest-advanced-mitigation" data-next-section="ddos_phase6_investigation"><i class="fa-solid fa-chart-line-up"></i><div class="btn-text">Option A: Invest in Advanced DDoS Mitigation Solutions.<small>Acquire more sophisticated DDoS protection services and hardware to make the infrastructure more resilient.</small></div></button>
                            <button class="btn" data-decision="ddos-p5-conduct-drills" data-next-section="ddos_phase6_investigation"><i class="fa-solid fa-users-medical"></i><div class="btn-text">Option B: Conduct Regular DDoS Simulations and Drills.<small>Organize regular drills to help the team act more quickly and in a coordinated manner during a crisis.</small></div></button>
                            <button class="btn" data-decision="ddos-p5-review-network-architecture" data-next-section="ddos_phase6_investigation"><i class="fa-solid fa-sitemap"></i><div class="btn-text">Option C: Redesign the Network Infrastructure for DDoS Resilience.<small>Make the network architecture distributed and redundant to prevent single points of failure.</small></div></button>
                        </div>
                    </div>
                    <div class="learning-note"><strong>Learning Note:</strong> Lessons learned after DDoS attacks are critical for future resilience. Technology investments, training, and architectural changes provide long-term protection.</div>
                </div>

                <div id="ddos_phase6_investigation" class="section">
                    <h2><i class="fa-solid fa-user-secret"></i> Phase 6: Investigation and Attribution</h2>
                    <h3>Time 4:30 - On the Attacker's Trail</h3>
                    <p>The attack has been completely stopped, and the systems are stable. CISO Melih Kaan now wants you to focus on finding out who attacked and why. The forensic team analyzed attack vectors, source IPs, and traffic patterns, identifying three potential suspects. </p>
                    
                    <div class="suspect-card">
                        <h4>Suspect 1: Disruptor Tech (Rival Company)</h4>
                        <p><strong>Motive:</strong> To sabotage Ã‡OLHAK Teknoloji's major e-commerce launch and gain a market advantage. <br>
                        <strong>Evidence:</strong> The attack was a sophisticated Layer 7 (application layer) attack specifically targeting new product-related API endpoints. This could indicate they have knowledge of your company's internal operations.</p>
                    </div>

                    <div class="suspect-card">
                        <h4>Suspect 2: Digital Justice Front (Hacktivist Group)</h4>
                        <p><strong>Motive:</strong> To protest Ã‡OLHAK Teknoloji's recently announced data policies, which caused public debate.<br>
                        <strong>Evidence:</strong> During the attack, numerous posts criticizing your company were made on social media accounts associated with the group. The attack was high-volume but less complex, focusing on Layer 3/4 (network layer).</p>
                    </div>

                    <div class="suspect-card">
                        <h4>Suspect 3: Crypto-Lock Gang (Ransom Group)</h4>
                        <p><strong>Motive:</strong> Purely financial. To take the company's services offline and demand a ransom.<br>
                        <strong>Evidence:</strong> 24 hours before the attack, a low-profile email that fell into the spam folder and was overlooked was found, demanding a payment of 5 BTC "to prevent disruptions to your services." The botnet used was also seen in previous attacks associated with this group.</p>
                    </div>
                    
                    <div class="interactive-element">
                          <h4>Now is the time to decide: In light of the evidence, who do you believe is behind the attack? This decision will affect legal action and future defense priorities.</h4>
                        <div class="decision-buttons">
                            <button class="btn" data-decision="ddos-p6-blame-competitor" data-next-section="finalSection"><i class="fa-solid fa-briefcase"></i><div class="btn-text">Option A: Rival Company (Disruptor Tech)<small>Present this information to management to initiate legal action and increase measures against industrial espionage.</small></div></button>
                            <button class="btn" data-decision="ddos-p6-blame-hacktivists" data-next-section="finalSection"><i class="fa-solid fa-masks-theater"></i><div class="btn-text">Option B: Hacktivist Group (Digital Justice Front)<small>Engage the public relations team to repair the company's public image and focus on reviewing policies.</small></div></button>
                            <button class="btn critical" data-decision="ddos-p6-blame-gang" data-next-section="finalSection"><i class="fa-solid fa-skull-crossbones"></i><div class="btn-text">Option C: Ransom Group (Crypto-Lock Gang)<small>Turn the investigation over to cybercrime units and strengthen defense mechanisms against future ransomware attacks.</small></div></button>
                        </div>
                    </div>
                </div>
                <div id="finalSection" class="section centered-page" style="display: none;">
                    <h2><i class="fa-solid fa-chart-line"></i> Post-DDoS Crisis Assessment Report</h2>
                    <p>The simulation is complete. Below is a detailed breakdown of your performance in managing the DDoS attack.</p>
                    <div id="performance-badge-container"><span id="performance-badge"></span></div>
                    <div class="final-metrics" id="finalMetricsContainer"></div>
                    <div class="post-crisis-layout">
                        <div class="event-timeline">
                            <h3><i class="fa-solid fa-timeline"></i> Decision Timeline</h3>
                            <ul id="decision-timeline-list"></ul>
                        </div>
                        <div class="strategic-debrief">
                            <h3><i class="fa-solid fa-lightbulb"></i> Strategic Assessment and Lessons Learned</h3>
                            <div id="strategic-debrief-content"></div>
                        </div>
                    </div>
                    <div class="decision-buttons" style="margin-top: 40px; display:flex; gap:12px; flex-wrap:wrap; justify-content:center;">
                        <button class="btn btn-start" onclick="location.reload()"><i class="fa-solid fa-arrow-rotate-right"></i> Restart Simulation</button>
                        <button class="btn" id="openLeaderboardBtn"><i class="fa-solid fa-trophy"></i> Leaderboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="lb-overlay" id="leaderboardOverlay" role="dialog" aria-modal="true" aria-labelledby="lbTitle">
  <div class="lb-modal">
    <div class="lb-header">
      <div class="lb-title" id="lbTitle"><i class="fa-solid fa-trophy"></i> Leaderboard</div>
      <div class="lb-sub">Scenario: <strong>v8-ddos</strong></div>
    </div>

    <div class="lb-tablewrap">
      <table class="lb-table" id="leaderboardTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Score</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody">
          <tr><td colspan="4">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <div class="lb-actions">
      <button class="lb-refresh" id="lbRefreshBtn"><i class="fa-solid fa-rotate"></i> Refresh</button>
      <button class="lb-close" id="lbCloseBtn"><i class="fa-solid fa-xmark"></i> Close</button>
    </div>
  </div>
</div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    // DDoS Simulation Logic - HARDENED VERSION + GLOBAL TIMER + LEADERBOARD
    window.game = {
        // METRICS
        score: { systemLoad: 'Extremely High', attackEffectiveness: 'Full', financialLoss: 0, downtime: 0, customerSatisfaction: 100 },
        // STATE
        state: {
            currentSectionId: 'start',
            decisionHistory: [],
            attribution: null,
            totalScore: null
        },
        // ELEMENT REFERENCES
        elements: {},
        // GLOBAL TIMER (4:00)
        timer: {
            total: 240,
            remaining: 240,
            intervalId: null,
            running: false
        },
        
        // DECISION IMPACTS (Already hardened)
        decisionInfo: {
            'ddos-p1-enable-onprem-mitigation': {
                title: "Activate On-Prem Mitigation",
                text: "You deployed your own systems. This was a fast initial response, but it proved insufficient against the massive scale of the attack, further stressing your systems and increasing costs.",
                strat: "Using your own resources is fast, but it usually only buys time during large-scale attacks and doesn't provide a complete solution. This move protects systems but also brings financial and operational burdens.",
                changes: { systemLoad: 'High', attackEffectiveness: 'Decreased', financialLoss: 25000, downtime: 30, customerSatisfaction: -15 },
                impact: 'Neutral'
            },
            'ddos-p1-contact-isp': {
                title: "Contact ISP and Request Filtering",
                text: "Reaching the ISP and convincing them to take action cost valuable minutes. During this delay, the attack continued at full strength, the service outage deepened, and customer trust plummeted.",
                strat: "While ISP support is critical, relying on an external party is a major risk during a crisis. Every minute of delay exponentially increases financial and reputational loss.",
                changes: { systemLoad: 'Extremely High', attackEffectiveness: 'Full', financialLoss: 60000, downtime: 60, customerSatisfaction: -30 },
                impact: 'Negative'
            },
            'ddos-p2-temporary-service-degradation': {
                title: "Shut Down Non-Critical Services",
                text: "You shut down some services to protect the core ones. This gave the servers some breathing room but meant a complete outage for customers using those services, leading to dissatisfaction.",
                strat: "Prioritizing services (triage) is a smart tactic, but it always comes at a cost. The decision of which service to sacrifice should be made by considering the impact on customer segments.",
                changes: { systemLoad: 'Medium', financialLoss: 15000, downtime: 5, customerSatisfaction: -18 },
                impact: 'Positive'
            },
            'ddos-p2-scale-up-resources': {
                title: "Scale Up Server Resources",
                text: "You tried to counter the attack with brute force by maxing out cloud resources. This gave the systems some resilience, but it also made them a bigger target for attackers and skyrocketed costs.",
                strat: "Throwing money at an attack is rarely an effective solution. Attackers often have more resources than your financial limits. This might be a temporary bandage, but it won't stop the bleeding.",
                changes: { systemLoad: 'High', financialLoss: 70000, downtime: 15, customerSatisfaction: -20 },
                impact: 'Negative'
            },
            'ddos-p3-rate-limiting': {
                title: "Apply Rate Limiting at the Application Layer",
                text: "You implemented aggressive rate limiting. This largely cut off Layer 7 bot traffic but also accidentally blocked some legitimate users and API integrations, leading to new complaints.",
                strat: "Rate limiting is one of the most effective weapons against L7 attacks, but its settings are very sensitive. Being too aggressive can mean doing the attacker's job for them.",
                changes: { systemLoad: 'Low', attackEffectiveness: 'Partially Controlled', financialLoss: 10000, downtime: 5, customerSatisfaction: -10 },
                impact: 'Positive'
            },
            'ddos-p3-captcha-challenges': {
                title: "Introduce CAPTCHA Challenges for Suspicious Traffic",
                text: "Showing a CAPTCHA for every suspicious request stopped the bots but ruined the user experience. Your customers got tired of proving they weren't robots every time they visited your site, and this tanked satisfaction.",
                strat: "CAPTCHA is a nuclear option. It effectively stops bots but also penalizes legitimate users. It should only be used temporarily and in the most desperate moments.",
                changes: { systemLoad: 'Medium', attackEffectiveness: 'Partially Controlled', financialLoss: 5000, downtime: 5, customerSatisfaction: -35 },
                impact: 'Neutral'
            },
            'ddos-p4-transparent-apology': {
                title: "Announce the Attack, Apologize, and Share Actions Taken",
                text: "You followed a policy of complete transparency. While this was appreciated by some customers, there was also a large group who saw the company as weak and lost trust. Repairing the reputation will be long and costly.",
                strat: "Transparency is often the best path, but timing and tone are critical. Announcements made before the crisis is under control can increase panic and make the company look weak.",
                changes: { customerSatisfaction: +5, financialLoss: 20000 },
                impact: 'Positive'
            },
            'ddos-p4-downplay-issue': {
                title: "Frame the Issue as 'Technical Glitch'",
                text: "You dismissed the problem as a 'technical glitch.' However, when cybersecurity reporters revealed the truth, your company was seen as both incompetent and dishonest. This created a reputational crisis that will be very difficult to fix.",
                strat: "Never lie. A lie told during a crisis can cause more damage than the crisis itself. Once trust is lost, it is almost impossible to regain.",
                changes: { customerSatisfaction: -60, financialLoss: 100000 },
                impact: 'Negative'
            },
            'ddos-p4-offer-compensation': {
                title: "Offer Compensation for Service Disruption",
                text: "You offered a generous compensation package to appease customers. While this increased satisfaction somewhat, it created a massive financial burden for the company and an image of a company that 'solves problems with money'.",
                strat: "Compensation is a gesture of goodwill but doesn't solve the fundamental problem. If your infrastructure is still weak, this is just a prepayment for the next crisis.",
                changes: { customerSatisfaction: +15, financialLoss: 80000 },
                impact: 'Neutral'
            },
            'ddos-p5-invest-advanced-mitigation': {
                title: "Invest in Advanced DDoS Mitigation Solutions",
                text: "You decided to invest in the most expensive and advanced protection systems. This will provide protection in the future but has created a massive hole in the budget.",
                strat: "Technology alone is not enough. Even the best tools can be ineffective without the right people and processes. This investment should be just one part of a holistic strategy.",
                changes: { financialLoss: 80000, customerSatisfaction: +5 },
                impact: 'Positive'
            },
            'ddos-p5-conduct-drills': {
                title: "Conduct Regular DDoS Simulations and Drills",
                text: "You planned regular drills to increase the team's readiness. This is one of the most cost-effective solutions for strengthening the human factor.",
                strat: "Building muscle memory is critical. The more teams practice, the calmer and more effective they will be during a real crisis.",
                changes: { financialLoss: 20000, customerSatisfaction: +10 },
                impact: 'Positive'
            },
            'ddos-p5-review-network-architecture': {
                title: "Redesign the Network Infrastructure for DDoS Resilience",
                text: "You initiated a project to redesign the architecture to make the infrastructure more resilient. While this is the most permanent solution in the long run, it will be time-consuming and costly to implement.",
                strat: "Resilience begins with design. It is always better to build a strong foundation from the start than to patch it during a crisis.",
                changes: { financialLoss: 50000, customerSatisfaction: +7 },
                impact: 'Positive'
            },
            'ddos-p6-blame-competitor': {
                title: "Attacker: Rival Company",
                text: "Despite weak evidence, you blamed the rival company. This triggered a legal battle and damaged your reputation in the industry. The real perpetrator is still out there.",
                strat: "Attribution requires solid evidence. A false accusation not only wastes resources but also blinds you to the real threat and can have legal consequences.",
                changes: { financialLoss: 50000, customerSatisfaction: -20 },
                impact: 'Negative',
                attribution: 'competitor'
            },
            'ddos-p6-blame-hacktivists': {
                title: "Attacker: Hacktivist Group",
                text: "You attributed the attack to hacktivists. This led the company to review its policies, but technical defense mechanisms were pushed to the background. The real perpetrator, the ransom group, is preparing for the next attack.",
                strat: "Misunderstanding the motive leads to the wrong defense. While you focused on a PR problem, you ignored your technical debt and vulnerabilities.",
                changes: { financialLoss: 10000, customerSatisfaction: -10 },
                impact: 'Negative',
                attribution: 'hacktivist'
            },
            'ddos-p6-blame-gang': {
                title: "Attacker: Ransom Group",
                text: "You correctly analyzed the evidence and determined that the attack was by a financially motivated gang. This ensured resources were focused on the correct threat model and paved the way for cooperation with law enforcement.",
                strat: "Correct attribution is the foundation of an effective defense. When you know your enemy, you can develop the right weapons and strategies against them.",
                changes: { financialLoss: 5000, customerSatisfaction: +10 },
                impact: 'Positive',
                attribution: 'gang'
            }
        },

        setup() {
            this.elements = {
                intro: document.getElementById('introSection'), 
                game: document.getElementById('gameContainer'), 
                gameContent: document.getElementById('game-content'),
                startButton: document.getElementById('startButton'), 
                intermission: document.getElementById('intermissionSection'),
                intermissionTitle: document.getElementById('intermissionTitle'), 
                intermissionText: document.getElementById('intermissionText'),
                intermissionMetrics: document.getElementById('intermissionMetrics'), 
                strategicText: document.getElementById('strategicText'),
                continueButton: document.getElementById('continueButton'),
                statusBar: { 
                    systemLoad: document.getElementById('status-systemLoad'),
                    attackEffectiveness: document.getElementById('status-attackEffectiveness'),
                    financialLoss: document.getElementById('status-financialLoss'),
                    downtime: document.getElementById('status-downtime'),
                    customerSatisfaction: document.getElementById('status-customerSatisfaction'),
                    remaining: document.getElementById('status-remaining')
                },
                leaderboard: {
                    overlay: document.getElementById('leaderboardOverlay'),
                    body: document.getElementById('leaderboardBody'),
                    table: document.getElementById('leaderboardTable'),
                    btnOpen: document.getElementById('openLeaderboardBtn'),
                    btnClose: document.getElementById('lbCloseBtn'),
                    btnRefresh: document.getElementById('lbRefreshBtn')
                }
            };
            this.loadGameHTML();
            this.attachListeners();
            this.elements.intro.style.display = 'flex';
            this.elements.game.style.display = 'none';
        },

        attachListeners() {
            this.elements.startButton.addEventListener('click', () => {
                this.elements.intro.style.display = 'none';
                this.elements.game.style.display = 'block';
                this.startGlobalTimer(); // ADDED: Start timer
                this.showSection('ddos_phase1_initial_detection'); 
            });
            
            this.elements.gameContent.addEventListener('click', (e) => {
                const button = e.target.closest('.btn[data-decision]');
                if (!button || button.disabled) {
                    return; 
                }
                
                const decisionId = button.dataset.decision;
                const nextSection = button.dataset.nextSection;



                this.handleDecision(decisionId, nextSection);
            });

            this.elements.continueButton.addEventListener('click', () => {
                const nextSectionId = this.elements.continueButton.dataset.nextSection;
                this.elements.intermission.style.display = 'none';
                
                if (nextSectionId === 'finalSection') {
                    this.showFinalReport();
                } else {
                    this.elements.game.style.display = 'block';
                    this.showSection(nextSectionId);
                }
            });

            // Leaderboard Modal buttons
            this.elements.leaderboard.btnOpen?.addEventListener('click', () => this.openLeaderboard());
            this.elements.leaderboard.btnClose?.addEventListener('click', () => this.closeLeaderboard());
            this.elements.leaderboard.btnRefresh?.addEventListener('click', () => this.loadLeaderboard());
            this.elements.leaderboard.overlay.addEventListener('click', (e) => {
                if (e.target === this.elements.leaderboard.overlay) this.closeLeaderboard();
            });
        },
        
        // APPLY DECISION
        handleDecision(decisionId, nextSectionId) {
            const info = this.decisionInfo[decisionId];
            if (!info) { console.error("Decision info not found:", decisionId); return; }

            this.score.systemLoad = info.changes.systemLoad || this.score.systemLoad;
            this.score.attackEffectiveness = info.changes.attackEffectiveness || this.score.attackEffectiveness;
            this.score.financialLoss += info.changes.financialLoss || 0;
            this.score.downtime += info.changes.downtime || 0;
            this.score.customerSatisfaction = Math.max(0, Math.min(100, this.score.customerSatisfaction + (info.changes.customerSatisfaction || 0)));
            if (info.attribution) {
                this.state.attribution = info.attribution;
            }

            this.state.decisionHistory.push({ id: decisionId, title: info.title, text: info.text, impactType: info.impact, sectionId: this.state.currentSectionId });
            
            this.updateState();
            this.showIntermission(info.title, info.text, info.strat, info.changes, nextSectionId);
        },

        // INTERMISSION SCREEN
        showIntermission(title, text, strat, changes, nextSectionId) {
            this.elements.intermissionTitle.textContent = title;
            this.elements.intermissionText.textContent = text;
            this.elements.strategicText.textContent = strat;
            
            let metricsHTML = '';
            const formatChange = (label, value, unit, icon) => {
                let colorClass = 'neutral';
                let displayValue = value;
                let arrowIcon = ''; 
                let sign = '';

                if (typeof value === 'number') {
                    if (value > 0) {
                        colorClass = (label === 'Customer Satisfaction') ? 'positive' : 'negative';
                        arrowIcon = 'fa-arrow-up-long';
                        sign = '+';
                    } else if (value < 0) {
                        colorClass = (label === 'Customer Satisfaction') ? 'negative' : 'positive';
                        arrowIcon = 'fa-arrow-down-long';
                    }
                    displayValue = `${sign}${value.toLocaleString('en-US')}`;
                } else {
                    colorClass = 'neutral';
                }

                return `<div class="metric-change ${colorClass}"><i class="fa-solid ${icon}"></i> ${label}: ${arrowIcon ? `<i class="fa-solid ${arrowIcon}"></i>` : ''} ${displayValue}${unit}</div>`;
            };

            if (changes.systemLoad !== undefined) metricsHTML += formatChange('System Load', changes.systemLoad, '', 'fa-gauge-high');
            if (changes.attackEffectiveness !== undefined) metricsHTML += formatChange('Attack Effectiveness', changes.attackEffectiveness, '', 'fa-shield-virus');
            if (changes.financialLoss !== undefined && changes.financialLoss !== 0) metricsHTML += formatChange('Financial Loss', changes.financialLoss, 'â‚º', 'fa-sack-dollar');
            if (changes.downtime !== undefined && changes.downtime !== 0) metricsHTML += formatChange('Downtime', changes.downtime, ' Minutes', 'fa-hourglass-half');
            if (changes.customerSatisfaction !== undefined && changes.customerSatisfaction !== 0) metricsHTML += formatChange('Customer Satisfaction', changes.customerSatisfaction, '', 'fa-heart-crack');
            
            if (metricsHTML === '') metricsHTML = '<p style="text-align: center; font-size: 1em; opacity: 0.8;">This decision had no direct impact on the metrics.</p>';

            this.elements.intermissionMetrics.innerHTML = metricsHTML;
            this.elements.continueButton.dataset.nextSection = nextSectionId;
            this.elements.game.style.display = 'none';
            this.elements.intermission.style.display = 'flex';
        },

        // UPDATE STATUS BAR
        updateStatusBar() {
            const s = this.score;
            this.elements.statusBar.systemLoad.textContent = s.systemLoad;
            this.elements.statusBar.attackEffectiveness.textContent = s.attackEffectiveness;
            this.elements.statusBar.financialLoss.textContent = `â‚º${s.financialLoss.toLocaleString('en-US')}`;
            this.elements.statusBar.downtime.textContent = `${s.downtime} Minutes`;
            this.elements.statusBar.customerSatisfaction.textContent = Math.max(0, s.customerSatisfaction);
        },

        // SHOW SECTION
        showSection(sectionId) {
            this.elements.sections.forEach(section => { section.style.display = 'none'; });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
                this.state.currentSectionId = sectionId;
                this.updateDynamicContent(sectionId); 
            } else {
                console.error('Section not found:', sectionId);
                this.showFinalReport();
            }
            this.updateState();
        },
        
        // FINAL REPORT + SCORING
        showFinalReport() {
            // Stop timer
            this.stopGlobalTimer();

            this.elements.intro.style.display = 'none';
            this.elements.intermission.style.display = 'none';
            this.elements.game.style.display = 'block'; 
            document.getElementById('statusBar').style.display = 'none';
            this.elements.sections.forEach(section => { section.style.display = 'none'; });
            
            const finalSection = document.getElementById('finalSection');
            if (!finalSection) { console.error("Final section not found in HTML!"); return; }
            finalSection.style.display = 'flex';
            
            const badge = document.getElementById('performance-badge');
            const metricsContainer = document.getElementById('finalMetricsContainer');
            const timelineList = document.getElementById('decision-timeline-list');
            const debriefContent = document.getElementById('strategic-debrief-content');
            
            // SCORING (slightly hardened)
            let totalScore = 100;
            const correctAttribution = this.state.attribution === 'gang';

            // 1) Financial Loss Penalty (2.0 points lost for every â‚º10,000)  <-- increased
            totalScore -= (this.score.financialLoss / 10000) * 1.0;

            // 2) Downtime Penalty (2.5 points lost for every 10 minutes) <-- increased
            totalScore -= (this.score.downtime / 10) * 1.5;

            // 3) Customer Satisfaction Penalty (0.6 points lost for every point below 100) <-- increased
            
            
            // 4) False Attribution Penalty (same)
            if (!correctAttribution) {
                totalScore -= 5;
            }


            let badgeInfo = {};
            if (totalScore >= 75 && correctAttribution) { 
                badgeInfo = { text: 'DDoS MASTER!', color: 'var(--accent-green)' };
            } else if (totalScore >= 55) { 
                badgeInfo = { text: 'RESILIENT NETWORK EXPERT', color: 'var(--accent-blue)' };
            } else if (totalScore >= 30) { 
                badgeInfo = { text: 'TOUGH DDoS EXPERIENCE', color: 'var(--accent-yellow)' };
            } else { 
                badgeInfo = { text: 'DDoS DISASTER', color: 'var(--accent-red)' };
            }

            badge.textContent = badgeInfo.text;
            badge.style.backgroundColor = badgeInfo.color;

            metricsContainer.innerHTML = `
                <div class="metric-card"><div class="icon"><i class="fa-solid fa-file-invoice-dollar"></i></div><div class="label">Final Score</div><div class="value">${totalScore}/100</div></div>
                <div class="metric-card"><div class="icon"><i class="fa-solid fa-sack-dollar"></i></div><div class="label">Financial Loss</div><div class="value">â‚º${this.score.financialLoss.toLocaleString('en-US')}</div></div>
                <div class="metric-card"><div class="icon"><i class="fa-solid fa-hourglass-half"></i></div><div class="label">Downtime</div><div class="value">${this.score.downtime} Minutes</div></div>
                <div class="metric-card"><div class="icon"><i class="fa-solid fa-heart-crack"></i></div><div class="label">Customer Satisfaction</div><div class="value">${this.score.customerSatisfaction}/100</div></div>
            `;

            timelineList.innerHTML = this.state.decisionHistory.map(decision => {
                let liClass = decision.impactType.toLowerCase();
                return `<li class="${liClass}"><span class="decision-title">${decision.title}</span></li>`;
            }).join('');

            let debriefHTML = `<p><strong>Your Overall Performance Score: ${totalScore}/100.</strong></p>`;
            if (badgeInfo.text === 'DDoS MASTER!') { 
                debriefHTML += `<p><strong>Exceptional Achievement!</strong> You accomplished the near impossible. You managed the crisis with minimal damage, cost, and downtime. Your decisions were not only technically sound but also strategically perfect. You have proven to be a master of cybersecurity.</p>`;
            } else if (badgeInfo.text === 'RESILIENT NETWORK EXPERT') { 
                debriefHTML += `<p><strong>Effective Crisis Management!</strong> You successfully weathered this tough scenario. Although there were some losses, you kept your composure and made the right strategic decisions, saving the company from a major disaster. This is a well-earned success.</p>`;
            } else if (badgeInfo.text === 'TOUGH DDoS EXPERIENCE') { 
                debriefHTML += `<p><strong>Major Lessons Learned.</strong> The crisis was overcome but at a heavy cost. The financial losses and downtime show how critical future preparation is. This experience was a painful but necessary lesson to understand your vulnerabilities.</p>`;
            } else { 
                debriefHTML += `<p><strong>DDoS DISASTER.</strong> Crisis management was inadequate, and the consequences were severe. A major blow was dealt to the company's financial standing, operations, and reputation. The company needs to fundamentally rebuild its cybersecurity strategy and emergency response plans.</p>`;
            }

            if (this.state.attribution) {
                if (correctAttribution) {
                    debriefHTML += `<p><strong>Investigation Note:</strong> You correctly identified the attacker (Ransom Group). This critical move saved you from a bigger disaster and significantly affected your score.</p>`;
                } else {
                    debriefHTML += `<p><strong>Investigation Note:</strong> You incorrectly identified the attacker. This major mistake led to resources being misallocated and seriously lowered your final score. Correct attribution is vital in a cyber crisis.</p>`;
                }
            }
            debriefContent.innerHTML = debriefHTML;
            
            // Automatically save score to leaderboard (name is not asked on this page)
            this.saveLeaderboard(totalScore);
        },
        
        updateState() { 
            this.updateStatusBar(); 
            this.updateSlackChat(this.state.currentSectionId); 
        },

        updateSlackChat(currentSection) {
            const chatViewer = document.getElementById(this.state.currentSectionId)?.querySelector('.slack-chat');
            if (!chatViewer) return; 

            let chat = '';
            if (currentSection === 'ddos_phase5_post_attack_recovery') {
                chat = `
                    <div class="message"><span class="sender ciso">CISO Melih Kaan:</span> We survived the attack, but we took a hit. We cannot be caught off guard like this again. We must take the right steps, regardless of the budget.</div>
                    <div class="message"><span class="sender cto">CTO Onur GÃ¼ngor:</span> Infrastructure, or team training? What should be our priority? Our resources are not unlimited.</div>
                    <div class="message"><span class="sender ceo">CEO Ayfer YÄ±ldÄ±z:</span> The financial outlook is not good. I need to see a return on every investment. Present me with the most cost-effective solution.</div>
                `;
            }
            chatViewer.innerHTML = chat;
        },
        
        updateDynamicContent(sectionId) {},

        loadGameHTML() {
            this.elements.sections = document.querySelectorAll('#game-content .section');
            if (typeof hljs !== 'undefined') {
                hljs.highlightAll();
            }
        },

        /* === GLOBAL TIMER === */
        startGlobalTimer() {
            if (this.timer.running) return;
            this.timer.running = true;
            this.timer.remaining = this.timer.total;
            this.updateTimerUI();
            this.timer.intervalId = setInterval(() => {
                this.timer.remaining--;
                this.updateTimerUI();
                if (this.timer.remaining <= 0) {
                    this.stopGlobalTimer();
                    // Time's up: go directly to the final report
                    this.showFinalReport();
                }
            }, 1000);
        },
        stopGlobalTimer() {
            if (this.timer.intervalId) clearInterval(this.timer.intervalId);
            this.timer.intervalId = null;
            this.timer.running = false;
        },
        updateTimerUI() {
            const m = String(Math.floor(this.timer.remaining / 60)).padStart(2,'0');
            const s = String(this.timer.remaining % 60).padStart(2,'0');
            this.elements.statusBar.remaining.textContent = `${m}:${s}`;
        },

        /* === LEADERBOARD === */
        openLeaderboard() {
            this.elements.leaderboard.overlay.style.display = 'flex';
            this.loadLeaderboard();
        },
        closeLeaderboard() {
            this.elements.leaderboard.overlay.style.display = 'none';
        },
        async saveLeaderboard(finalScore) {
            const name = (localStorage.getItem('playerName') || 'Anonymous').toString().slice(0, 40);
            const payload = {
                scenario: 'v8-ddos',
                name,
                score: finalScore,
                details: {
                    financialLoss: this.score.financialLoss,
                    downtime: this.score.downtime,
                    customerSatisfaction: this.score.customerSatisfaction,
                    attribution: this.state.attribution,
                    decisions: this.state.decisionHistory.map(d => d.id)
                },
                timeSpentSec: this.timer.total - this.timer.remaining,
                timestamp: new Date().toISOString()
            };

            // Backend dene
            try {
                const res = await fetch('/api/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
            } catch(e) {
                // Fallback: localStorage
                const key = 'leaderboard-v8-ddos';
                const arr = JSON.parse(localStorage.getItem(key) || '[]');
                arr.push(payload);
                arr.sort((a,b)=> b.score - a.score);
                localStorage.setItem(key, JSON.stringify(arr.slice(0,100)));
            }
        },
        async loadLeaderboard() {
            const tbody = this.elements.leaderboard.body;
            const key = 'leaderboard-v8-ddos';
            tbody.innerHTML = `<tr><td colspan="4">Loadingâ€¦</td></tr>`;
            let rows = [];
            // Ã–nce backend
            try {
                const res = await fetch('/api/leaderboard?scenario=v8-ddos', { method:'GET' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json(); // beklenen: [{name, score, timestamp}, ...]
                rows = Array.isArray(data) ? data : [];
            } catch(e) {
                // Fallback: localStorage
                const arr = JSON.parse(localStorage.getItem(key) || '[]');
                rows = arr.map(x => ({ name: x.name, score: x.score, timestamp: x.timestamp }));
            }

            if (!rows.length) {
                tbody.innerHTML = `<tr><td colspan="4">No records yet.</td></tr>`;
                return;
            }
            rows.sort((a,b)=> b.score - a.score);
            tbody.innerHTML = rows.slice(0,50).map((r,i)=>`
                <tr>
                    <td>${i+1}</td>
                    <td>${(r.name || 'Anonymous').toString().slice(0,40)}</td>
                    <td>${r.score}</td>
                    <td>${r.timestamp ? new Date(r.timestamp).toLocaleString('en-US') : '-'}</td>
                </tr>
            `).join('');
        }
    };

    window.game.setup();
});
    </script>
</body>
</html>
